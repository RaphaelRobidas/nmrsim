

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>nmrtools.nmrmath &mdash; nmrtools 0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> nmrtools
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction to nmrtools v0.0.1 (pre-alpha)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../feedback.html">Feedback</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../acknowledgements.html">Acknowledgements</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">nmrtools</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>nmrtools.nmrmath</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for nmrtools.nmrmath</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Provides functions for the calculation of NMR spectra.</span>

<span class="sd">This version of nmrmath features speed-optimized hamiltonian, simsignals,</span>
<span class="sd">and transition_matrix functions. Up to at least 8 spins, the new non-sparse</span>
<span class="sd">Hamilton code is about 10x faster. The overall performance is dramatically</span>
<span class="sd">better than the original code.</span>

<span class="sd">TODO: elaborate; list functions; provide examples.</span>

<span class="sd">References</span>
<span class="sd">----------</span>

<span class="sd">Formulas for simulating two uncoupled spin-1/2 nuclei are derived from:</span>
<span class="sd">Sandstrom, J. *Dynamic NMR Spectroscopy*; Academic Press, 1982, p. 15.</span>

<span class="sd">Formulas for simulating two coupled spin-1/2 nuclei are derived from:</span>
<span class="sd">Brown, K.C.; Tyson, R. L.; Weil, J. A. *J. Chem. Educ.* **1998**, *75*, 1632.</span>
<span class="sd">(NOTE: Hans Reich pointed out that the paper has a sign typo in Equation (2b)!</span>
<span class="sd">the last term is minus-over-plus, not plus-over-minus.)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">sqrt</span>

<span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="k">import</span> <span class="n">eigh</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="k">import</span> <span class="n">kron</span><span class="p">,</span> <span class="n">csc_matrix</span><span class="p">,</span> <span class="n">csr_matrix</span><span class="p">,</span> <span class="n">lil_matrix</span><span class="p">,</span> <span class="n">bmat</span>

<span class="c1">##############################################################################</span>
<span class="c1"># Second-order, Quantum Mechanics routines</span>
<span class="c1">##############################################################################</span>


<div class="viewcode-block" id="popcount"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.popcount">[docs]</a><span class="k">def</span> <span class="nf">popcount</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the popcount (binary Hamming weight) of integer `n`.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    n : a base-10 integer</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Popcount (binary Hamming weight) of `n`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">bin</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_allowed"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.is_allowed">[docs]</a><span class="k">def</span> <span class="nf">is_allowed</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines if a transition between two spin states is allowed or forbidden.</span>

<span class="sd">    It turns out that for a system of n spin-half nuclei, the numbers from 0</span>
<span class="sd">    to (2^n - 1) code for each spin state. For example:</span>

<span class="sd">        0 = 000 = alpha-alpha-alpha</span>
<span class="sd">        1 = 001 = alpha-alpha-beta</span>
<span class="sd">        .</span>
<span class="sd">        .</span>
<span class="sd">        .</span>
<span class="sd">        7 = 111 = beta-beta-beta</span>

<span class="sd">    For a transition to be allowed, the total spin of the system cannot</span>
<span class="sd">    change by more than one. This corresponds to only one bit being flipped</span>
<span class="sd">    in the binary number representation. The Hamming weight is the number of</span>
<span class="sd">    bits flipped.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    m, n : int</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        `true` = allowed, `false` = forbidden</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">popcount</span><span class="p">(</span><span class="n">m</span> <span class="o">^</span> <span class="n">n</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="transition_matrix"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.transition_matrix">[docs]</a><span class="k">def</span> <span class="nf">transition_matrix</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a matrix of allowed transitions.</span>

<span class="sd">    The integers 0-`n`, in their binary form, code for a spin state</span>
<span class="sd">    (alpha/beta). The (i,j) cells in the matrix indicate whether a transition</span>
<span class="sd">    from spin state i to spin state j is allowed or forbidden.</span>
<span class="sd">    See the ``is_allowed`` function for more information.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    n : dimension of the n,n matrix (i.e. number of possible spin states).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lil_matrix</span>
<span class="sd">        a transition matrix that can be used to compute the intensity of</span>
<span class="sd">    allowed transitions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># function was optimized by only calculating upper triangle and then adding</span>
    <span class="c1"># the lower.</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">lil_matrix</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>  <span class="c1"># sparse matrix created</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">is_allowed</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
                <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">T</span> <span class="o">+</span> <span class="n">T</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">T</span></div>


<div class="viewcode-block" id="hamiltonian"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.hamiltonian">[docs]</a><span class="k">def</span> <span class="nf">hamiltonian</span><span class="p">(</span><span class="n">freqlist</span><span class="p">,</span> <span class="n">couplings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the spin Hamiltonian for `n` spin-1/2 nuclei.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    freqlist : array-like</span>
<span class="sd">        a list of frequencies in Hz of length `n`</span>
<span class="sd">    couplings : array-like</span>
<span class="sd">        an `n` x `n` array of coupling constants in Hz</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        a 2-D array for the spin Hamiltonian</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nspins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">freqlist</span><span class="p">)</span>

    <span class="c1"># Define Pauli matrices</span>
    <span class="n">sigma_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
    <span class="n">sigma_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="n">j</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
    <span class="n">sigma_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]])</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>

    <span class="c1"># The following empty arrays will be used to store the</span>
    <span class="c1"># Cartesian spin operators.</span>
    <span class="n">Lx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">nspins</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>
    <span class="n">Ly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">nspins</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>
    <span class="n">Lz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">nspins</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspins</span><span class="p">):</span>
        <span class="n">Lx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">Ly</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">Lz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspins</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>                                  <span class="c1"># Diagonal element</span>
                <span class="n">Lx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">Lx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">],</span> <span class="n">sigma_x</span><span class="p">)</span>
                <span class="n">Ly</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">Ly</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">],</span> <span class="n">sigma_y</span><span class="p">)</span>
                <span class="n">Lz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">Lz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">],</span> <span class="n">sigma_z</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                                       <span class="c1"># Off-diagonal element</span>
                <span class="n">Lx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">Lx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">],</span> <span class="n">unit</span><span class="p">)</span>
                <span class="n">Ly</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">Ly</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">],</span> <span class="n">unit</span><span class="p">)</span>
                <span class="n">Lz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">Lz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">],</span> <span class="n">unit</span><span class="p">)</span>

    <span class="n">Lcol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">Lx</span><span class="p">,</span> <span class="n">Ly</span><span class="p">,</span> <span class="n">Lz</span><span class="p">))</span><span class="o">.</span><span class="n">real</span>
    <span class="n">Lrow</span> <span class="o">=</span> <span class="n">Lcol</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># As opposed to sparse version of code, this works!</span>
    <span class="n">Lproduct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Lrow</span><span class="p">,</span> <span class="n">Lcol</span><span class="p">)</span>

    <span class="c1"># Hamiltonian operator</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="n">nspins</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="n">nspins</span><span class="p">))</span>

    <span class="c1"># Add Zeeman interactions:</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspins</span><span class="p">):</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">H</span> <span class="o">+</span> <span class="n">freqlist</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">*</span> <span class="n">Lz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span>

    <span class="c1"># Scalar couplings</span>

    <span class="c1"># Testing with MATLAB discovered J must be /2.</span>
    <span class="c1"># Believe it is related to the fact that in the SpinDynamics.org simulation</span>
    <span class="c1"># freqs are *2pi, but Js by pi only.</span>
    <span class="n">scalars</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">couplings</span>
    <span class="n">scalars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">scalars</span><span class="p">,</span> <span class="n">Lproduct</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspins</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspins</span><span class="p">):</span>
            <span class="n">H</span> <span class="o">+=</span> <span class="n">scalars</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">real</span>

    <span class="k">return</span> <span class="n">H</span></div>


<div class="viewcode-block" id="simsignals"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.simsignals">[docs]</a><span class="k">def</span> <span class="nf">simsignals</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">nspins</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the eigensolution of the spin Hamiltonian H and, using it,</span>
<span class="sd">    returns the allowed transitions as list of (frequency, intensity) tuples.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>

<span class="sd">    H : ndarray</span>
<span class="sd">        the spin Hamiltonian.</span>
<span class="sd">    nspins : int</span>
<span class="sd">        the number of nuclei in the spin system.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    spectrum : [(float, float)...]</span>
<span class="sd">        a list of (frequency, intensity) tuples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># This routine was optimized for speed by vectorizing the intensity</span>
    <span class="c1"># calculations, replacing a nested-for signal-by-signal calculation.</span>
    <span class="c1"># Considering that hamiltonian was dramatically faster when refactored to</span>
    <span class="c1"># use arrays instead of sparse matrices, consider an array refactor to this</span>
    <span class="c1"># function as well.</span>

    <span class="c1"># The eigensolution calculation apparently must be done on a dense matrix,</span>
    <span class="c1"># because eig functions on sparse matrices can&#39;t return all answers?!</span>
    <span class="c1"># Using eigh so that answers have only real components and no residual small</span>
    <span class="c1"># unreal components b/c of rounding errors</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>    <span class="c1"># V will be eigenvectors, v will be frequencies</span>

    <span class="c1"># Eigh still leaves residual 0j terms, so:</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asmatrix</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>

    <span class="c1"># Calculate signal intensities</span>
    <span class="n">Vcol</span> <span class="o">=</span> <span class="n">csc_matrix</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">Vrow</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">(</span><span class="n">Vcol</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">nspins</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">transition_matrix</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">Vrow</span> <span class="o">*</span> <span class="n">T</span> <span class="o">*</span> <span class="n">Vcol</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">todense</span><span class="p">())</span>

    <span class="n">spectrum</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>  <span class="c1"># consider making this minimum intensity</span>
                                <span class="c1"># cutoff a function arg, for flexibility</span>
                <span class="n">v</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">E</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">spectrum</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">spectrum</span></div>


<span class="c1"># TODO: think about normalize and normalize_ name spacing; will need kwargs</span>
<span class="c1"># to agree across apps.</span>
<div class="viewcode-block" id="nspinspec"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.nspinspec">[docs]</a><span class="k">def</span> <span class="nf">nspinspec</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">couplings</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates second-order spectral data (freqency and intensity of signals)</span>
<span class="sd">    for *n* spin-half nuclei.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    freqs : [float...]</span>
<span class="sd">        a list of *n* nuclei frequencies in Hz</span>
<span class="sd">    couplings : array-like</span>
<span class="sd">        an *n, n* array of couplings in Hz. The order</span>
<span class="sd">        of nuclei in the list corresponds to the column and row order in the</span>
<span class="sd">        matrix, e.g. couplings[0][1] and [1]0] are the J coupling between</span>
<span class="sd">        the nuclei of freqs[0] and freqs[1].</span>
<span class="sd">    normalize: bool</span>
<span class="sd">        True if the intensities should be normalized so that total intensity</span>
<span class="sd">        equals the total number of nuclei.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    spectrum : [(float, float)...]</span>
<span class="sd">        a list of (frequency, intensity) tuples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nspins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">hamiltonian</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">couplings</span><span class="p">)</span>
    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">simsignals</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">nspins</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">normalize_spectrum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">nspins</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spectrum</span></div>


<span class="c1">##############################################################################</span>
<span class="c1"># First-order simulation</span>
<span class="c1">##############################################################################</span>

<span class="c1"># doublet, multiplet, add_peaks, and reduce_peaks are used to generate</span>
<span class="c1"># first-order splitting patterns</span>

<div class="viewcode-block" id="doublet"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.doublet">[docs]</a><span class="k">def</span> <span class="nf">doublet</span><span class="p">(</span><span class="n">plist</span><span class="p">,</span> <span class="n">J</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies a *J* coupling to each signal in a list of (frequency, intensity)</span>
<span class="sd">    signals, creating two half-intensity signals at +/- *J*/2.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    plist : [(float, float)...]</span>
<span class="sd">        a list of (frequency{Hz}, intensity) tuples.</span>
<span class="sd">    J : float</span>
<span class="sd">        The coupling constant in Hz.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    [(float, float)...]</span>
<span class="sd">        a list of (frequency, intensity) tuples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">plist</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">v</span> <span class="o">-</span> <span class="n">J</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">v</span> <span class="o">+</span> <span class="n">J</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="multiplet"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.multiplet">[docs]</a><span class="k">def</span> <span class="nf">multiplet</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">couplings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Splits a set of signals into first-order multiplets.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    signal : (float, float)</span>
<span class="sd">        a (frequency{Hz}, intensity) tuple;</span>
<span class="sd">    couplings : [(float, int)...]</span>
<span class="sd">        A list of (*J*, # of nuclei) tuples. The order of the tuples in</span>
<span class="sd">        couplings does not matter.</span>
<span class="sd">        e.g. to split a signal into a *dt, J* = 8, 5 Hz, use:</span>
<span class="sd">        ``couplings = [(8, 2), (5, 3)]``</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    [(float, float)...]</span>
<span class="sd">        a plist of the multiplet that results from splitting the plist</span>
<span class="sd">        signal(s) by each J.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">signal</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">coupling</span> <span class="ow">in</span> <span class="n">couplings</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">coupling</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">doublet</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">coupling</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="add_peaks"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.add_peaks">[docs]</a><span class="k">def</span> <span class="nf">add_peaks</span><span class="p">(</span><span class="n">plist</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reduces a list of (frequency, intensity) tuples to an</span>
<span class="sd">    (average frequency, total intensity) tuple.</span>

<span class="sd">    Argument</span>
<span class="sd">    --------</span>
<span class="sd">    plist: [(float, float)...]</span>
<span class="sd">        a list of (frequency, intensity) tuples</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    (float, float)</span>
<span class="sd">        a tuple of (average frequency, total intensity)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Is this if statement necessary?</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">plist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># nothing to add</span>
    <span class="n">v_total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">i_total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">plist</span><span class="p">:</span>
        <span class="n">v_total</span> <span class="o">+=</span> <span class="n">v</span>
        <span class="n">i_total</span> <span class="o">+=</span> <span class="n">i</span>
    <span class="k">return</span> <span class="n">v_total</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">plist</span><span class="p">),</span> <span class="n">i_total</span></div>


<div class="viewcode-block" id="reduce_peaks"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.reduce_peaks">[docs]</a><span class="k">def</span> <span class="nf">reduce_peaks</span><span class="p">(</span><span class="n">plist</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes an ordered list of (x, y) tuples and adds together tuples whose first</span>
<span class="sd">    values are within a certain tolerance limit.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    plist : [(float, float)...]</span>
<span class="sd">        A *sorted* list of (x, y) tuples (sorted by x)</span>
<span class="sd">    tolerance : float</span>
<span class="sd">        tuples that differ in x by &lt;= tolerance are combined using ``add_peaks``</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    [(float, float)...]</span>
<span class="sd">        a list of (x, y) tuples where all x values differ by &gt; `tolerance`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">work</span> <span class="o">=</span> <span class="p">[</span><span class="n">plist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>  <span class="c1"># an accumulator of peaks to be processed</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">plist</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">work</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plist</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">plist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">work</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">tolerance</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># accumulate close peaks</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add_peaks</span><span class="p">(</span><span class="n">work</span><span class="p">))</span>
            <span class="n">work</span> <span class="o">=</span> <span class="p">[</span><span class="n">plist</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">work</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add_peaks</span><span class="p">(</span><span class="n">work</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">res</span></div>


<span class="k">def</span> <span class="nf">_normalize</span><span class="p">(</span><span class="n">intensities</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scale a list of intensities so that they sum to the total number of</span>
<span class="sd">    nuclei.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    intensities : [float...]</span>
<span class="sd">        A list of intensities.</span>
<span class="sd">    n : int</span>
<span class="sd">        Number of nuclei.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">intensities</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">intensity</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">intensities</span><span class="p">):</span>
        <span class="n">intensities</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">intensity</span> <span class="o">*</span> <span class="n">factor</span>


<div class="viewcode-block" id="first_order"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.first_order">[docs]</a><span class="k">def</span> <span class="nf">first_order</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">couplings</span><span class="p">):</span>  <span class="c1"># Wa, RightHz, WdthHz not implemented yet</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Splits a signal into a first-order multiplet.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    signal : (float, float)</span>
<span class="sd">        a (frequency, intensity) tuple.</span>
<span class="sd">    couplings : [(float, int)...]</span>
<span class="sd">        a list of (J, # of nuclei) tuples.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    [(float, float)...}</span>
<span class="sd">        a plist-style spectrum (list of (frequency, intensity) tuples)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">reduce_peaks</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">multiplet</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">couplings</span><span class="p">)))</span></div>


<div class="viewcode-block" id="normalize_spectrum"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.normalize_spectrum">[docs]</a><span class="k">def</span> <span class="nf">normalize_spectrum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize the intensities in a spectrum so that total intensity equals</span>
<span class="sd">    value n (nominally the number of nuclei giving rise to the signal).</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    spectrum : [(float, float)...]</span>
<span class="sd">        a list of (frequency, intensity) tuples.</span>
<span class="sd">    n : int or float</span>
<span class="sd">        total intensity to normalize to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">freq</span><span class="p">,</span> <span class="n">int_</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="p">],</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="p">]</span>
    <span class="n">_normalize</span><span class="p">(</span><span class="n">int_</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">int_</span><span class="p">))</span></div>


<span class="c1">##############################################################################</span>
<span class="c1"># Non-QM solutions for specific second-order patterns</span>
<span class="c1">##############################################################################</span>

<span class="c1"># TODO: consistent names/API between arguments and internal variables.</span>
<span class="c1"># Cobbling these together from various sources resulted in inconsistencies</span>
<span class="c1"># between variable names in Reich&#39;s VB6 code and other sources. Need to find</span>
<span class="c1"># specific references for all formulas and refactor to consistent variable</span>
<span class="c1"># names.</span>
<span class="c1"># TODO: appropriate use of normalize-- for which of these functions, if any,</span>
<span class="c1"># is normalization possibly of interest?</span>

<div class="viewcode-block" id="AB"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.AB">[docs]</a><span class="k">def</span> <span class="nf">AB</span><span class="p">(</span><span class="n">Jab</span><span class="p">,</span> <span class="n">Vab</span><span class="p">,</span> <span class="n">Vcentr</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the signal frequencies and intensities for two strongly</span>
<span class="sd">    coupled protons (Ha and Hb).</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    Jab : float</span>
<span class="sd">        the coupling constant (Hz) between Ha and Hb</span>
<span class="sd">    Vab : float</span>
<span class="sd">        the chemical shift difference (Hz) between Ha and Hb in the absence</span>
<span class="sd">        of coupling.</span>
<span class="sd">    Vcentr : float</span>
<span class="sd">        the frequency (Hz) for the center of the AB quartet.</span>
<span class="sd">    normalize: bool</span>
<span class="sd">        whether the signal intensity should be normalized.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    [(float, float)...]</span>
<span class="sd">        a list of four (frequency, intensity) tuples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">Jab</span>
    <span class="n">dv</span> <span class="o">=</span> <span class="n">Vab</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">((</span><span class="n">dv</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">J</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">Vcentr</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">center</span> <span class="o">-</span> <span class="n">c</span> <span class="o">-</span> <span class="p">(</span><span class="n">J</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">+</span> <span class="n">J</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">center</span> <span class="o">+</span> <span class="n">c</span> <span class="o">-</span> <span class="p">(</span><span class="n">J</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="n">v3</span> <span class="o">+</span> <span class="n">J</span>
    <span class="n">dI</span> <span class="o">=</span> <span class="n">J</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>
    <span class="n">I1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">dI</span>
    <span class="n">I2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dI</span>
    <span class="n">I3</span> <span class="o">=</span> <span class="n">I2</span>
    <span class="n">I4</span> <span class="o">=</span> <span class="n">I1</span>
    <span class="n">vList</span> <span class="o">=</span> <span class="p">[</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">,</span> <span class="n">v4</span><span class="p">]</span>
    <span class="n">IList</span> <span class="o">=</span> <span class="p">[</span><span class="n">I1</span><span class="p">,</span> <span class="n">I2</span><span class="p">,</span> <span class="n">I3</span><span class="p">,</span> <span class="n">I4</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">_normalize</span><span class="p">(</span><span class="n">IList</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">vList</span><span class="p">,</span> <span class="n">IList</span><span class="p">))</span></div>


<div class="viewcode-block" id="AB2"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.AB2">[docs]</a><span class="k">def</span> <span class="nf">AB2</span><span class="p">(</span><span class="n">Jab</span><span class="p">,</span> <span class="n">Vab</span><span class="p">,</span> <span class="n">Vcentr</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates signal frequencies and intensities for an AB2 spin system.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    Jab : float</span>
<span class="sd">        the Ha-Hb coupling constant (Hz).</span>
<span class="sd">    Vab : float</span>
<span class="sd">        the difference in the frequencies (Hz) of Ha and Hb in the absence of</span>
<span class="sd">        coupling.</span>
<span class="sd">    Vcentr : float</span>
<span class="sd">        the frequency (Hz) for the center of the AB2 signal.</span>
<span class="sd">    normalize: bool</span>
<span class="sd">        whether the signal intensity should be normalized.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    [(float, float)...]</span>
<span class="sd">        a list of (frequency, intensity) tuples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Currently, there is a disconnect between the variable names in the GUI</span>
    <span class="c1"># and the variable names in this function. The following code provides a</span>
    <span class="c1"># temporary interface.</span>

    <span class="n">J</span><span class="p">,</span> <span class="n">dV</span><span class="p">,</span> <span class="n">Vab</span> <span class="o">=</span> <span class="n">Jab</span><span class="p">,</span> <span class="n">Vab</span><span class="p">,</span> <span class="n">Vcentr</span>

    <span class="c1"># for now, old Jupyter code using Pople equations kept hashed out for now</span>
    <span class="c1"># Reich vs. Pople variable names are confused, e.g. Vab</span>
    <span class="c1"># So, variables being placed by position in the def header--CAUTION</span>
    <span class="c1"># From main passed in order of: Jab, Vab, Vcentr, Wa, RightHz, WdthHz</span>
    <span class="c1"># Here read in as:              J,   dV,  Vab,    &quot;     &quot;        &quot;</span>
    <span class="c1"># dV = va - vb  # Reich: used d = Vb - vA and then mucked with sign of d</span>
    <span class="c1"># Vab = (va + vb) / 2  # Reich: ABOff</span>
    <span class="n">dV</span> <span class="o">=</span> <span class="o">-</span> <span class="n">dV</span>
    <span class="n">va</span> <span class="o">=</span> <span class="n">Vab</span> <span class="o">+</span> <span class="p">(</span><span class="n">dV</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">vb</span> <span class="o">=</span> <span class="n">va</span> <span class="o">-</span> <span class="n">dV</span>
    <span class="n">Jmod</span> <span class="o">=</span> <span class="n">J</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># This factor used in frequency calculations</span>

    <span class="c1"># In Reich&#39;s code, the definitions of cp/cm (for C_plus/C_minus) were</span>
    <span class="c1"># swapped, and then modifications using sign of d were employed. This</span>
    <span class="c1"># code hews closer to Pople definitions</span>
    <span class="n">C_plus</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dV</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dV</span> <span class="o">*</span> <span class="n">J</span> <span class="o">+</span> <span class="p">(</span><span class="mi">9</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">J</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">C_minus</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dV</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">dV</span> <span class="o">*</span> <span class="n">J</span> <span class="o">+</span> <span class="p">(</span><span class="mi">9</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">J</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">cos2theta_plus</span> <span class="o">=</span> <span class="p">(</span><span class="n">dV</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">J</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="n">C_plus</span>  <span class="c1"># Reich: cos2x</span>
    <span class="n">cos2theta_minus</span> <span class="o">=</span> <span class="p">(</span><span class="n">dV</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">J</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="n">C_minus</span>  <span class="c1"># Reich: cos2y</span>

    <span class="c1"># This code differs from Reich&#39;s in the calculation of</span>
    <span class="c1"># the sin/cos x/y values</span>

    <span class="n">sintheta_plus</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos2theta_plus</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Reich: sinx</span>
    <span class="n">sintheta_minus</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos2theta_minus</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Reich: siny</span>
    <span class="n">costheta_plus</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">cos2theta_plus</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Reich: cosx</span>
    <span class="n">costheta_minus</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">cos2theta_minus</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Reich: cosy</span>

    <span class="c1"># Intensity formulas use the sin and cos of (theta_plus - theta_minus)</span>
    <span class="c1"># sin_dtheta is Reich&#39;s qq; cos_dtheta is Reich&#39;s rr</span>

    <span class="n">sin_dtheta</span> <span class="o">=</span> <span class="n">sintheta_plus</span> <span class="o">*</span> <span class="n">costheta_minus</span> <span class="o">-</span> <span class="n">costheta_plus</span> <span class="o">*</span> <span class="n">sintheta_minus</span>
    <span class="n">cos_dtheta</span> <span class="o">=</span> <span class="n">costheta_plus</span> <span class="o">*</span> <span class="n">costheta_minus</span> <span class="o">+</span> <span class="n">sintheta_plus</span> <span class="o">*</span> <span class="n">sintheta_minus</span>

    <span class="c1"># Calculate the frequencies and intensities.</span>
    <span class="c1"># V1-V4 are &quot;Origin: A&quot; (PSB Table 6-8);</span>
    <span class="c1"># V5-V8 are &quot;Origin: B&quot;;</span>
    <span class="c1"># V9-V12 are &quot;Origin: Comb.&quot;</span>

    <span class="n">V1</span> <span class="o">=</span> <span class="n">Vab</span> <span class="o">+</span> <span class="n">Jmod</span> <span class="o">+</span> <span class="n">C_plus</span>
    <span class="n">V2</span> <span class="o">=</span> <span class="n">vb</span> <span class="o">+</span> <span class="n">C_plus</span> <span class="o">+</span> <span class="n">C_minus</span>
    <span class="n">V3</span> <span class="o">=</span> <span class="n">va</span>
    <span class="n">V4</span> <span class="o">=</span> <span class="n">Vab</span> <span class="o">-</span> <span class="n">Jmod</span> <span class="o">+</span> <span class="n">C_minus</span>
    <span class="n">V5</span> <span class="o">=</span> <span class="n">vb</span> <span class="o">+</span> <span class="n">C_plus</span> <span class="o">-</span> <span class="n">C_minus</span>
    <span class="n">V6</span> <span class="o">=</span> <span class="n">Vab</span> <span class="o">+</span> <span class="n">Jmod</span> <span class="o">-</span> <span class="n">C_plus</span>
    <span class="n">V7</span> <span class="o">=</span> <span class="n">vb</span> <span class="o">-</span> <span class="n">C_plus</span> <span class="o">+</span> <span class="n">C_minus</span>
    <span class="n">V8</span> <span class="o">=</span> <span class="n">Vab</span> <span class="o">-</span> <span class="n">Jmod</span> <span class="o">-</span> <span class="n">C_minus</span>
    <span class="n">V9</span> <span class="o">=</span> <span class="n">vb</span> <span class="o">-</span> <span class="n">C_plus</span> <span class="o">-</span> <span class="n">C_minus</span>

    <span class="n">I1</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">sintheta_plus</span> <span class="o">-</span> <span class="n">costheta_plus</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">I2</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin_dtheta</span> <span class="o">+</span> <span class="n">costheta_plus</span> <span class="o">*</span> <span class="n">costheta_minus</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">I3</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">I4</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">sintheta_minus</span> <span class="o">+</span> <span class="n">costheta_minus</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">I5</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos_dtheta</span> <span class="o">+</span> <span class="n">costheta_plus</span> <span class="o">*</span> <span class="n">sintheta_minus</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">I6</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">costheta_plus</span> <span class="o">+</span> <span class="n">sintheta_plus</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">I7</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos_dtheta</span> <span class="o">-</span> <span class="n">sintheta_plus</span> <span class="o">*</span> <span class="n">costheta_minus</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">I8</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">costheta_minus</span> <span class="o">-</span> <span class="n">sintheta_minus</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">I9</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin_dtheta</span> <span class="o">+</span> <span class="n">sintheta_plus</span> <span class="o">*</span> <span class="n">sintheta_minus</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">vList</span> <span class="o">=</span> <span class="p">[</span><span class="n">V1</span><span class="p">,</span> <span class="n">V2</span><span class="p">,</span> <span class="n">V3</span><span class="p">,</span> <span class="n">V4</span><span class="p">,</span> <span class="n">V5</span><span class="p">,</span> <span class="n">V6</span><span class="p">,</span> <span class="n">V7</span><span class="p">,</span> <span class="n">V8</span><span class="p">,</span> <span class="n">V9</span><span class="p">]</span>
    <span class="n">IList</span> <span class="o">=</span> <span class="p">[</span><span class="n">I1</span><span class="p">,</span> <span class="n">I2</span><span class="p">,</span> <span class="n">I3</span><span class="p">,</span> <span class="n">I4</span><span class="p">,</span> <span class="n">I5</span><span class="p">,</span> <span class="n">I6</span><span class="p">,</span> <span class="n">I7</span><span class="p">,</span> <span class="n">I8</span><span class="p">,</span> <span class="n">I9</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">_normalize</span><span class="p">(</span><span class="n">IList</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">vList</span><span class="p">,</span> <span class="n">IList</span><span class="p">))</span></div>


<div class="viewcode-block" id="ABX"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.ABX">[docs]</a><span class="k">def</span> <span class="nf">ABX</span><span class="p">(</span><span class="n">Jab</span><span class="p">,</span> <span class="n">Jbx</span><span class="p">,</span> <span class="n">Jax</span><span class="p">,</span> <span class="n">Vab</span><span class="p">,</span> <span class="n">Vcentr</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reich-style inputs for an ABX spin system.</span>
<span class="sd">    Jab is the A-B coupling constant (Hz)</span>
<span class="sd">    dV is the difference in nuclei frequencies in the absence of coupling (Hz)</span>
<span class="sd">    Vab is the frequency for the center of the AB2 signal</span>
<span class="sd">    Wa is width of peak at half-height (not implemented yet)</span>
<span class="sd">    RightHz is the lower frequency limit for the window (not implemented yet)</span>
<span class="sd">    WdthHz is the width of the window in Hz (not implemented yet)</span>
<span class="sd">    return: peaklist of (frequency, intensity) tuples</span>
<span class="sd">    Calculates signal frequencies and intensities for an ABX spin system.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    Jab : float</span>
<span class="sd">        the Ha-Hb coupling constant (Hz).</span>
<span class="sd">    Jbx : float</span>
<span class="sd">        the Ha-Hb coupling constant (Hz).</span>
<span class="sd">    Jax : float</span>
<span class="sd">        the Ha-Hb coupling constant (Hz).</span>
<span class="sd">    Vab : float</span>
<span class="sd">        the difference in the frequencies (Hz) of Ha and Hb in the absence of</span>
<span class="sd">        coupling.</span>
<span class="sd">    Vcentr : float</span>
<span class="sd">        the frequency (Hz) for the center of the AB2 signal.</span>
<span class="sd">    normalize: bool</span>
<span class="sd">        whether the signal intensity should be normalized.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    [(float, float)...]</span>
<span class="sd">        a list of (frequency, intensity) tuples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    In the WINDNMR main toolbar, only the parameters in the function args </span>
<span class="sd">    can be changed (Jab, Jax, Jbx, Vab, Vcentr, ignoring the </span>
<span class="sd">    Wa/Right-Hz/WdthHz parameters that nmrtools isn&#39;t adopting). However, </span>
<span class="sd">    in WINDNMR parameters popup, each individual chemical shift for Ha, Hb, </span>
<span class="sd">    and Hx can be entered.</span>
<span class="sd">    </span>
<span class="sd">    In the original WINDNMR interface, Vab is the difference in Ha/Hb </span>
<span class="sd">    frequencies in the absence of coupling, and Vcentr is the average of </span>
<span class="sd">    those frequencies.</span>
<span class="sd">    </span>
<span class="sd">    There&#39;s two ways I can see a user wanting to use the ABX function:</span>
<span class="sd">    1. as in WINDNMR: to see the effect of moving signals closer to each </span>
<span class="sd">    other by adjusting Vab/Vcentr</span>
<span class="sd">    2. as in 2nd-order: supplying frequencies for all signals and Js. </span>
<span class="sd">    </span>
<span class="sd">    The ABX formula here is a simplification that assumes X is far away in </span>
<span class="sd">    chemical shift. Moving the frequency of x (vx) closer to those of a and b</span>
<span class="sd">    (va, vb) has no effect. Whatever the final decision is on API </span>
<span class="sd">    implementation, this difference must be clear to the user.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Another function where Reich vs. non-Reich variable names gets confusing</span>
    <span class="c1"># See comments in AB2 function</span>
    <span class="c1"># So, variables being placed by position in the def header--CAUTION</span>
    <span class="c1"># From main passed in order of: Jab, Jax, Jbx, Vab,  Vcentr, ...</span>
    <span class="c1"># Here read in as:              Jab, Jbx, Jax, dVab, Vab,    ...</span>

    <span class="c1"># CHANGE: with switch to kwargs used in function calls, the following</span>
    <span class="c1"># code matches this Reich code to the current view dictionary</span>
    <span class="n">Jbx</span><span class="p">,</span> <span class="n">Jax</span> <span class="o">=</span> <span class="n">Jax</span><span class="p">,</span> <span class="n">Jbx</span>
    <span class="n">dVab</span> <span class="o">=</span> <span class="n">Vab</span>
    <span class="n">Vab</span> <span class="o">=</span> <span class="n">Vcentr</span>

    <span class="c1"># dVab = va - vb  # Reich: Vab</span>
    <span class="c1"># Vab = (va + vb) / 2  # Reich: ABOff</span>

    <span class="c1"># Reich&#39;s ABX: vx initialized as vb + 100</span>
    <span class="n">vx</span> <span class="o">=</span> <span class="n">Vab</span> <span class="o">-</span> <span class="p">(</span><span class="n">dVab</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">100</span>

    <span class="n">dJx</span> <span class="o">=</span> <span class="n">Jax</span> <span class="o">-</span> <span class="n">Jbx</span>  <span class="c1"># GMS stepping-stone constant for readability</span>

    <span class="c1"># Retaining Reich names for next two constants</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">dJx</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">cp</span> <span class="o">=</span> <span class="n">Jax</span> <span class="o">+</span> <span class="n">Jbx</span>

    <span class="c1"># Reich re-defines constants m and l</span>
    <span class="c1"># (declaration/garbage-collection efficiency?)</span>
    <span class="c1"># GMS: using M and L for the first instance, m and n for second</span>
    <span class="c1"># (avoid lower-case l for variables)</span>
    <span class="c1"># Reich redefines m a third time for calculating X intensities</span>
    <span class="c1"># GMS: uses t</span>

    <span class="n">M</span> <span class="o">=</span> <span class="n">dVab</span> <span class="o">+</span> <span class="n">cm</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">dVab</span> <span class="o">-</span> <span class="n">cm</span>

    <span class="n">D_plus</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">M</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">Jab</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">D_minus</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">L</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">Jab</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">sin2phi_plus</span> <span class="o">=</span> <span class="n">Jab</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">D_plus</span><span class="p">)</span>  <span class="c1"># Reich: sin2x</span>
    <span class="n">sin2phi_minus</span> <span class="o">=</span> <span class="n">Jab</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">D_minus</span><span class="p">)</span>  <span class="c1"># Reich: sin2y</span>
    <span class="n">cos2phi_plus</span> <span class="o">=</span> <span class="n">M</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">D_plus</span><span class="p">)</span>  <span class="c1"># Reich: cos2x</span>
    <span class="n">cos2phi_minus</span> <span class="o">=</span> <span class="n">L</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">D_minus</span><span class="p">)</span>  <span class="c1"># Reich: cos2y</span>

    <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Jab</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span>
    <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">cp</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Jab</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span>  <span class="c1"># Reich: l</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">cos2phi_plus</span> <span class="o">*</span> <span class="n">cos2phi_minus</span> <span class="o">+</span> <span class="n">sin2phi_plus</span> <span class="o">*</span> <span class="n">sin2phi_minus</span>
    <span class="c1"># Calculate the frequencies and intensities.</span>
    <span class="c1"># V1-V4 are &quot;Origin: B&quot; (PSB Table 6-15);</span>
    <span class="c1"># V5-V8 are &quot;Origin: A&quot;;</span>
    <span class="c1"># V9-V12 are &quot;Origin: X&quot; and V13-14 are &quot;Origin: Comb. (X)&quot;</span>

    <span class="n">V1</span> <span class="o">=</span> <span class="n">Vab</span> <span class="o">-</span> <span class="n">m</span> <span class="o">-</span> <span class="n">D_minus</span>
    <span class="n">V2</span> <span class="o">=</span> <span class="n">Vab</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="n">D_plus</span>
    <span class="n">V3</span> <span class="o">=</span> <span class="n">Vab</span> <span class="o">-</span> <span class="n">n</span> <span class="o">-</span> <span class="n">D_minus</span>
    <span class="n">V4</span> <span class="o">=</span> <span class="n">Vab</span> <span class="o">+</span> <span class="n">m</span> <span class="o">-</span> <span class="n">D_plus</span>
    <span class="n">V5</span> <span class="o">=</span> <span class="n">Vab</span> <span class="o">-</span> <span class="n">m</span> <span class="o">+</span> <span class="n">D_minus</span>
    <span class="n">V6</span> <span class="o">=</span> <span class="n">Vab</span> <span class="o">+</span> <span class="n">n</span> <span class="o">+</span> <span class="n">D_plus</span>
    <span class="n">V7</span> <span class="o">=</span> <span class="n">Vab</span> <span class="o">-</span> <span class="n">n</span> <span class="o">+</span> <span class="n">D_minus</span>
    <span class="n">V8</span> <span class="o">=</span> <span class="n">Vab</span> <span class="o">+</span> <span class="n">m</span> <span class="o">+</span> <span class="n">D_plus</span>
    <span class="n">V9</span> <span class="o">=</span> <span class="n">vx</span> <span class="o">-</span> <span class="n">cp</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">V10</span> <span class="o">=</span> <span class="n">vx</span> <span class="o">+</span> <span class="n">D_plus</span> <span class="o">-</span> <span class="n">D_minus</span>
    <span class="n">V11</span> <span class="o">=</span> <span class="n">vx</span> <span class="o">-</span> <span class="n">D_plus</span> <span class="o">+</span> <span class="n">D_minus</span>
    <span class="n">V12</span> <span class="o">=</span> <span class="n">vx</span> <span class="o">+</span> <span class="n">cp</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">V13</span> <span class="o">=</span> <span class="n">vx</span> <span class="o">-</span> <span class="n">D_plus</span> <span class="o">-</span> <span class="n">D_minus</span>
    <span class="n">V14</span> <span class="o">=</span> <span class="n">vx</span> <span class="o">+</span> <span class="n">D_plus</span> <span class="o">+</span> <span class="n">D_minus</span>
    <span class="n">I1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sin2phi_minus</span>
    <span class="n">I2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sin2phi_plus</span>
    <span class="n">I3</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">sin2phi_minus</span>
    <span class="n">I4</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">sin2phi_plus</span>
    <span class="n">I5</span> <span class="o">=</span> <span class="n">I3</span>
    <span class="n">I6</span> <span class="o">=</span> <span class="n">I4</span>
    <span class="n">I7</span> <span class="o">=</span> <span class="n">I1</span>
    <span class="n">I8</span> <span class="o">=</span> <span class="n">I2</span>
    <span class="n">I9</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">I10</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">I11</span> <span class="o">=</span> <span class="n">I10</span>
    <span class="n">I12</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">I13</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">I14</span> <span class="o">=</span> <span class="n">I13</span>
    <span class="n">VList</span> <span class="o">=</span> <span class="p">[</span><span class="n">V1</span><span class="p">,</span> <span class="n">V2</span><span class="p">,</span> <span class="n">V3</span><span class="p">,</span> <span class="n">V4</span><span class="p">,</span> <span class="n">V5</span><span class="p">,</span> <span class="n">V6</span><span class="p">,</span> <span class="n">V7</span><span class="p">,</span> <span class="n">V8</span><span class="p">,</span> <span class="n">V9</span><span class="p">,</span> <span class="n">V10</span><span class="p">,</span> <span class="n">V11</span><span class="p">,</span> <span class="n">V12</span><span class="p">,</span> <span class="n">V13</span><span class="p">,</span> <span class="n">V14</span><span class="p">]</span>
    <span class="n">IList</span> <span class="o">=</span> <span class="p">[</span><span class="n">I1</span><span class="p">,</span> <span class="n">I2</span><span class="p">,</span> <span class="n">I3</span><span class="p">,</span> <span class="n">I4</span><span class="p">,</span> <span class="n">I5</span><span class="p">,</span> <span class="n">I6</span><span class="p">,</span> <span class="n">I7</span><span class="p">,</span> <span class="n">I8</span><span class="p">,</span> <span class="n">I9</span><span class="p">,</span> <span class="n">I10</span><span class="p">,</span> <span class="n">I11</span><span class="p">,</span> <span class="n">I12</span><span class="p">,</span> <span class="n">I13</span><span class="p">,</span> <span class="n">I14</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">_normalize</span><span class="p">(</span><span class="n">IList</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">VList</span><span class="p">,</span> <span class="n">IList</span><span class="p">))</span></div>


<div class="viewcode-block" id="ABX3"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.ABX3">[docs]</a><span class="k">def</span> <span class="nf">ABX3</span><span class="p">(</span><span class="n">Jab</span><span class="p">,</span> <span class="n">Jax</span><span class="p">,</span> <span class="n">Jbx</span><span class="p">,</span> <span class="n">Vab</span><span class="p">,</span> <span class="n">Vcentr</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulation of the AB part of an ABX3 spin system.</span>

<span class="sd">    TODO: explain simplification</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    Jab : float</span>
<span class="sd">        the Ha-Hb coupling constant (Hz).</span>
<span class="sd">    Jax : float</span>
<span class="sd">        the Ha-Hb coupling constant (Hz).</span>
<span class="sd">    Jbx : float</span>
<span class="sd">        the Ha-Hb coupling constant (Hz).</span>
<span class="sd">    Vab : float</span>
<span class="sd">        the difference in the frequencies (Hz) of Ha and Hb in the absence of</span>
<span class="sd">        coupling.</span>
<span class="sd">    Vcentr : float</span>
<span class="sd">        the frequency (Hz) for the center of the AB2 signal.</span>
<span class="sd">    normalize: bool</span>
<span class="sd">        whether the signal intensity should be normalized.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    [(float, float)...]</span>
<span class="sd">        a list of (frequency, intensity) tuples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Refactoring of Reich&#39;s code for simulating the ABX3 system.</span>
    <span class="n">va</span> <span class="o">=</span> <span class="n">Vcentr</span> <span class="o">-</span> <span class="n">Vab</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">vb</span> <span class="o">=</span> <span class="n">Vcentr</span> <span class="o">+</span> <span class="n">Vab</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">a_quartet</span> <span class="o">=</span> <span class="n">first_order</span><span class="p">((</span><span class="n">va</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">[(</span><span class="n">Jax</span><span class="p">,</span> <span class="mi">3</span><span class="p">)])</span>
    <span class="n">b_quartet</span> <span class="o">=</span> <span class="n">first_order</span><span class="p">((</span><span class="n">vb</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">[(</span><span class="n">Jbx</span><span class="p">,</span> <span class="mi">3</span><span class="p">)])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">dv</span> <span class="o">=</span> <span class="n">b_quartet</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">a_quartet</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">abcenter</span> <span class="o">=</span> <span class="p">(</span><span class="n">b_quartet</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">a_quartet</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">sub_abq</span> <span class="o">=</span> <span class="n">AB</span><span class="p">(</span><span class="n">Jab</span><span class="p">,</span> <span class="n">dv</span><span class="p">,</span> <span class="n">abcenter</span><span class="p">,</span> <span class="n">normalize</span><span class="p">)</span>  <span class="c1"># Wa, RightHz, WdthHz not</span>
        <span class="c1"># implemented</span>
        <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">a_quartet</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">scaled_sub_abq</span> <span class="o">=</span> <span class="p">[(</span><span class="n">v</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sub_abq</span><span class="p">]</span>
        <span class="n">res</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">scaled_sub_abq</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">_normalize</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1">#TODO: check this factor</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="AAXX"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.AAXX">[docs]</a><span class="k">def</span> <span class="nf">AAXX</span><span class="p">(</span><span class="n">Jaa</span><span class="p">,</span> <span class="n">Jxx</span><span class="p">,</span> <span class="n">Jax</span><span class="p">,</span> <span class="n">Jax_prime</span><span class="p">,</span> <span class="n">Vcentr</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulates one half (&#39;A&#39; part) of an AA&#39;XX&#39; spin system.</span>

<span class="sd">    All frequencies are in Hz.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    float Jaa, Jax, Jax, Jax_prime :</span>
<span class="sd">        Jaa is the JAA&#39; coupling constant;</span>
<span class="sd">        Jxx the JXX&#39;;</span>
<span class="sd">        Jax the JAX; and</span>
<span class="sd">        JAX_prime the JAX&#39;.</span>
<span class="sd">    Vcentr : float</span>
<span class="sd">        the frequency for the center of the signal.</span>
<span class="sd">    normalize: bool</span>
<span class="sd">        whether the signal intensity should be normalized.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    [(float, float)...]</span>
<span class="sd">        a list of (frequency, intensity) tuples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define the constants required to calculate frequencies and intensities</span>

    <span class="c1"># K, L, M, N are as defined in PSB</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">Jaa</span> <span class="o">+</span> <span class="n">Jxx</span>  <span class="c1"># Reich: K</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">Jaa</span> <span class="o">-</span> <span class="n">Jxx</span>  <span class="c1"># Reich: l</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">Jax</span> <span class="o">-</span> <span class="n">Jax_prime</span>  <span class="c1"># Reich: m</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">Jax</span> <span class="o">+</span> <span class="n">Jax_prime</span>  <span class="c1"># Reich: n</span>

    <span class="c1"># Retaining Reich names for next two constants</span>
    <span class="c1"># Suggested refactoring: don&#39;t divide by 2 here; can simplify later formulas</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">K</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">L</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">M</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">L</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">sin2theta_s</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">K</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">p</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">sin2theta_a</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">M</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">r</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">cos2theta_s</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">K</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">p</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">cos2theta_a</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">M</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">r</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># Calculate the frequencies and intensities.</span>
    <span class="c1"># See PSB Table 6-18. Transitions 1-4 are condensed into V1 and V2.</span>

    <span class="n">V1</span> <span class="o">=</span> <span class="n">Vcentr</span> <span class="o">+</span> <span class="n">N</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">V2</span> <span class="o">=</span> <span class="n">Vcentr</span> <span class="o">-</span> <span class="n">N</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">V3</span> <span class="o">=</span> <span class="n">Vcentr</span> <span class="o">+</span> <span class="n">K</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">p</span>
    <span class="n">V4</span> <span class="o">=</span> <span class="n">Vcentr</span> <span class="o">-</span> <span class="n">K</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">p</span>
    <span class="n">V5</span> <span class="o">=</span> <span class="n">Vcentr</span> <span class="o">+</span> <span class="n">K</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">p</span>
    <span class="n">V6</span> <span class="o">=</span> <span class="n">Vcentr</span> <span class="o">-</span> <span class="n">K</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">p</span>
    <span class="n">V7</span> <span class="o">=</span> <span class="n">Vcentr</span> <span class="o">+</span> <span class="n">M</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">r</span>
    <span class="n">V8</span> <span class="o">=</span> <span class="n">Vcentr</span> <span class="o">-</span> <span class="n">M</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">r</span>
    <span class="n">V9</span> <span class="o">=</span> <span class="n">Vcentr</span> <span class="o">+</span> <span class="n">M</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">r</span>
    <span class="n">V10</span> <span class="o">=</span> <span class="n">Vcentr</span> <span class="o">-</span> <span class="n">M</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">r</span>

    <span class="n">I1</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">I2</span> <span class="o">=</span> <span class="n">I1</span>
    <span class="n">I3</span> <span class="o">=</span> <span class="n">sin2theta_s</span>
    <span class="n">I4</span> <span class="o">=</span> <span class="n">cos2theta_s</span>
    <span class="n">I5</span> <span class="o">=</span> <span class="n">I4</span>
    <span class="n">I6</span> <span class="o">=</span> <span class="n">I3</span>
    <span class="n">I7</span> <span class="o">=</span> <span class="n">sin2theta_a</span>
    <span class="n">I8</span> <span class="o">=</span> <span class="n">cos2theta_a</span>
    <span class="n">I9</span> <span class="o">=</span> <span class="n">I8</span>
    <span class="n">I10</span> <span class="o">=</span> <span class="n">I7</span>

    <span class="n">VList</span> <span class="o">=</span> <span class="p">[</span><span class="n">V1</span><span class="p">,</span> <span class="n">V2</span><span class="p">,</span> <span class="n">V3</span><span class="p">,</span> <span class="n">V4</span><span class="p">,</span> <span class="n">V5</span><span class="p">,</span> <span class="n">V6</span><span class="p">,</span> <span class="n">V7</span><span class="p">,</span> <span class="n">V8</span><span class="p">,</span> <span class="n">V9</span><span class="p">,</span> <span class="n">V10</span><span class="p">]</span>
    <span class="n">IList</span> <span class="o">=</span> <span class="p">[</span><span class="n">I1</span><span class="p">,</span> <span class="n">I2</span><span class="p">,</span> <span class="n">I3</span><span class="p">,</span> <span class="n">I4</span><span class="p">,</span> <span class="n">I5</span><span class="p">,</span> <span class="n">I6</span><span class="p">,</span> <span class="n">I7</span><span class="p">,</span> <span class="n">I8</span><span class="p">,</span> <span class="n">I9</span><span class="p">,</span> <span class="n">I10</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">_normalize</span><span class="p">(</span><span class="n">IList</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">VList</span><span class="p">,</span> <span class="n">IList</span><span class="p">))</span></div>


<div class="viewcode-block" id="AABB"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.AABB">[docs]</a><span class="k">def</span> <span class="nf">AABB</span><span class="p">(</span><span class="n">Vab</span><span class="p">,</span> <span class="n">Jaa</span><span class="p">,</span> <span class="n">Jbb</span><span class="p">,</span> <span class="n">Jab</span><span class="p">,</span> <span class="n">Jab_prime</span><span class="p">,</span> <span class="n">Vcentr</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A wrapper for a second-order AA&#39;BB&#39; calculation, but using the</span>
<span class="sd">    values taken from the WINDNMR-style AA&#39;BB&#39; bar selected by the Multiplet</span>
<span class="sd">    menu.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>

<span class="sd">    Vab : float</span>
<span class="sd">        the difference in frequency (Hz) between Ha and Hb in the absence of</span>
<span class="sd">        coupling.</span>
<span class="sd">    float Jaa, Jbb, Jab, Jab_prime :</span>
<span class="sd">        Jaa is the JAA&#39; coupling constant;</span>
<span class="sd">        Jxx the JXX&#39;;</span>
<span class="sd">        Jax the JAX; and</span>
<span class="sd">        JAX_prime the JAX&#39;.</span>
<span class="sd">    Vcentr : float</span>
<span class="sd">        the frequency for the center of the signal.</span>
<span class="sd">    normalize: bool</span>
<span class="sd">        whether the signal intensity should be normalized.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    [(float, float)...]</span>
<span class="sd">        a list of (frequency, intensity) tuples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">va</span> <span class="o">=</span> <span class="n">Vcentr</span> <span class="o">-</span> <span class="n">Vab</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">vb</span> <span class="o">=</span> <span class="n">Vcentr</span> <span class="o">+</span> <span class="n">Vab</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">freqlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">va</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">vb</span><span class="p">,</span> <span class="n">vb</span><span class="p">]</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">J</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Jaa</span>
    <span class="n">J</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Jab</span>
    <span class="n">J</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Jab_prime</span>
    <span class="n">J</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Jab_prime</span>
    <span class="n">J</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Jab</span>
    <span class="n">J</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Jbb</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">J</span> <span class="o">+</span> <span class="n">J</span><span class="o">.</span><span class="n">T</span>

    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">nspinspec</span><span class="p">(</span><span class="n">freqlist</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="p">]</span>  <span class="c1"># TODO check that this should be deleted</span>

    <span class="k">return</span> <span class="n">spectrum</span></div>


<span class="c1">##############################################################################</span>
<span class="c1"># Simulation of DNMR lineshapes</span>
<span class="c1">##############################################################################</span>

<span class="c1"># There are multiple, redundant routines for calculating DNMR lineshapes. All</span>
<span class="c1">#  previous approaches are preserved here for now.</span>
<span class="c1"># TODO: review, refactor, and select the best-performing functions based on</span>
<span class="c1"># speed test results.</span>

<div class="viewcode-block" id="dnmr_2spin"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.dnmr_2spin">[docs]</a><span class="k">def</span> <span class="nf">dnmr_2spin</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">vb</span><span class="p">,</span> <span class="n">ka</span><span class="p">,</span> <span class="n">Wa</span><span class="p">,</span> <span class="n">Wb</span><span class="p">,</span> <span class="n">pa</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A translation of the equation from Sandström&#39;s Dynamic NMR Spectroscopy,</span>
<span class="sd">    p. 14, for the uncoupled 2-site exchange simulation.</span>
<span class="sd">    v: frequency whose amplitude is to be calculated</span>
<span class="sd">    va, vb: frequencies of a and b singlets (slow exchange limit) (va &gt; vb)</span>
<span class="sd">    ka: rate constant for state A--&gt; state B</span>
<span class="sd">    pa: fraction of population in state Adv: frequency difference (va - vb)</span>
<span class="sd">    between a and b singlets (slow exchange)</span>
<span class="sd">    Wa, Wb: peak widths at half height (slow exchange), used to calculate T2s</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">pb</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pa</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="n">pb</span> <span class="o">/</span> <span class="n">ka</span>
    <span class="n">dv</span> <span class="o">=</span> <span class="n">va</span> <span class="o">-</span> <span class="n">vb</span>
    <span class="n">Dv</span> <span class="o">=</span> <span class="p">(</span><span class="n">va</span> <span class="o">+</span> <span class="n">vb</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">v</span>
    <span class="n">T2a</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Wa</span><span class="p">)</span>
    <span class="n">T2b</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Wb</span><span class="p">)</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">T2a</span> <span class="o">*</span> <span class="n">T2b</span><span class="p">))</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Dv</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
               <span class="p">(</span><span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">dv</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">P</span> <span class="o">+=</span> <span class="p">((</span><span class="n">pa</span> <span class="o">/</span> <span class="n">T2a</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">pb</span> <span class="o">/</span> <span class="n">T2b</span><span class="p">))</span>

    <span class="n">Q</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">Dv</span> <span class="o">-</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">dv</span> <span class="o">*</span> <span class="p">(</span><span class="n">pa</span> <span class="o">-</span> <span class="n">pb</span><span class="p">))</span>

    <span class="n">R</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">Dv</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">tau</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="n">T2a</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">T2b</span><span class="p">)))</span>
    <span class="n">R</span> <span class="o">+=</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">dv</span> <span class="o">*</span> <span class="n">tau</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="n">T2b</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">T2a</span><span class="p">))</span> <span class="o">+</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">dv</span> <span class="o">*</span> <span class="p">(</span><span class="n">pa</span> <span class="o">-</span> <span class="n">pb</span><span class="p">)</span>

    <span class="n">I</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">tau</span> <span class="o">*</span> <span class="p">((</span><span class="n">pb</span> <span class="o">/</span> <span class="n">T2a</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">pa</span> <span class="o">/</span> <span class="n">T2b</span><span class="p">)))</span> <span class="o">+</span> <span class="n">Q</span> <span class="o">*</span> <span class="n">R</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">P</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">R</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">I</span></div>


<div class="viewcode-block" id="two_spin"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.two_spin">[docs]</a><span class="k">def</span> <span class="nf">two_spin</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">vb</span><span class="p">,</span> <span class="n">ka</span><span class="p">,</span> <span class="n">wa</span><span class="p">,</span> <span class="n">wb</span><span class="p">,</span> <span class="n">pa</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;pyDNMR renamed dnmr_2spin and some arguments. This is temporary glue</span>
<span class="sd">    to make sure that pyDNMR will work with the nmrtools library.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">dnmr_2spin</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">vb</span><span class="p">,</span> <span class="n">ka</span><span class="p">,</span> <span class="n">wa</span><span class="p">,</span> <span class="n">wb</span><span class="p">,</span> <span class="n">pa</span><span class="p">)</span></div>


<div class="viewcode-block" id="d2s_func"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.d2s_func">[docs]</a><span class="k">def</span> <span class="nf">d2s_func</span><span class="p">(</span><span class="n">va</span><span class="p">,</span> <span class="n">vb</span><span class="p">,</span> <span class="n">ka</span><span class="p">,</span> <span class="n">wa</span><span class="p">,</span> <span class="n">wb</span><span class="p">,</span> <span class="n">pa</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a function that requires only frequency as an argurment, and used to</span>
<span class="sd">    calculate intensities across array of frequencies in the DNMR</span>
<span class="sd">    spectrum for two uncoupled spin-half nuclei.</span>

<span class="sd">    The idea is to calculate expressions</span>
<span class="sd">    that are independant of frequency only once, and then use them in a new</span>
<span class="sd">    function that depends only on v. This would avoid unneccessarily</span>
<span class="sd">    repeating some of the same operations.</span>

<span class="sd">    This function-within-a-function should be refactored to</span>
<span class="sd">    function-within-class!</span>

<span class="sd">    :param va: The frequency of nucleus &#39;a&#39; at the slow exchange limit. va &gt; vb</span>
<span class="sd">    :param vb: The frequency of nucleus &#39;b&#39; at the slow exchange limit. vb &lt; va</span>
<span class="sd">    :param ka: The rate constant for state a--&gt; state b</span>
<span class="sd">    :param wa: The width at half heigh of the signal for nucleus a (at the slow</span>
<span class="sd">    exchange limit).</span>
<span class="sd">    :param wb: The width at half heigh of the signal for nucleus b (at the slow</span>
<span class="sd">    exchange limit).</span>
<span class="sd">    :param pa: The fraction of the population in state a.</span>
<span class="sd">    :param pa: fraction of population in state a</span>
<span class="sd">    wa, wb: peak widths at half height (slow exchange), used to calculate T2s</span>

<span class="sd">    returns: a function that takes v (x coord or numpy linspace) as an argument</span>
<span class="sd">    and returns intensity (y).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: factor pis out; redo comments to explain excision of v-independent</span>
    <span class="c1"># terms</span>

    <span class="n">pi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">pi_squared</span> <span class="o">=</span> <span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">T2a</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="n">wa</span><span class="p">)</span>
    <span class="n">T2b</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="n">wb</span><span class="p">)</span>
    <span class="n">pb</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pa</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="n">pb</span> <span class="o">/</span> <span class="n">ka</span>
    <span class="n">dv</span> <span class="o">=</span> <span class="n">va</span> <span class="o">-</span> <span class="n">vb</span>
    <span class="n">Dv</span> <span class="o">=</span> <span class="p">(</span><span class="n">va</span> <span class="o">+</span> <span class="n">vb</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">T2a</span> <span class="o">*</span> <span class="n">T2b</span><span class="p">)</span> <span class="o">+</span> <span class="n">pi_squared</span> <span class="o">*</span> <span class="p">(</span><span class="n">dv</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">pa</span> <span class="o">/</span> <span class="n">T2a</span> <span class="o">+</span> <span class="n">pb</span> <span class="o">/</span> <span class="n">T2b</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">tau</span> <span class="o">*</span> <span class="p">((</span><span class="n">pb</span> <span class="o">/</span> <span class="n">T2a</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">pa</span> <span class="o">/</span> <span class="n">T2b</span><span class="p">))</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">dv</span> <span class="o">*</span> <span class="p">(</span><span class="n">pa</span> <span class="o">-</span> <span class="n">pb</span><span class="p">))</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">dv</span> <span class="o">*</span> <span class="n">tau</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="n">T2b</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">T2a</span><span class="p">))</span> <span class="o">+</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">dv</span> <span class="o">*</span> <span class="p">(</span><span class="n">pa</span> <span class="o">-</span> <span class="n">pb</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">tau</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="n">T2a</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">T2b</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">maker</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scheduled for refactoring.</span>
<span class="sd">        :param v: frequency</span>
<span class="sd">        :return: function that calculates the intensity at v</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: fix docstring, explain _P _Q etc correlate to P, Q etc in lit.</span>
        <span class="c1"># FIXED: previous version of this function used</span>
        <span class="c1"># nonlocal Dv, P, Q, R</span>
        <span class="c1"># but apparently when function called repeatedly these values would</span>
        <span class="c1"># become corrupted (turning into arrays?!)</span>
        <span class="c1"># Solution: add underscores to create copies of any variables in</span>
        <span class="c1"># outer scope whose values are changed in the inner scope.</span>

        <span class="n">_Dv</span> <span class="o">=</span> <span class="n">Dv</span> <span class="o">-</span> <span class="n">v</span>
        <span class="n">_P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">-</span> <span class="n">tau</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pi_squared</span> <span class="o">*</span> <span class="p">(</span><span class="n">_Dv</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">_Q</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">+</span> <span class="n">tau</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">_Dv</span>
        <span class="n">_R</span> <span class="o">=</span> <span class="n">R</span> <span class="o">+</span> <span class="n">_Dv</span> <span class="o">*</span> <span class="n">r</span>
        <span class="k">return</span><span class="p">(</span><span class="n">_P</span> <span class="o">*</span> <span class="n">p</span> <span class="o">+</span> <span class="n">_Q</span> <span class="o">*</span> <span class="n">_R</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">_P</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">_R</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">maker</span></div>


<div class="viewcode-block" id="reich"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.reich">[docs]</a><span class="k">def</span> <span class="nf">reich</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">vb</span><span class="p">,</span> <span class="n">ka</span><span class="p">,</span> <span class="n">Wa</span><span class="p">,</span> <span class="n">Wb</span><span class="p">,</span> <span class="n">pa</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A traslation of the actual VB code used in WINDNMR. Was used for error</span>
<span class="sd">    checking. Scheduled for deletion.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># print(&#39;Reich was entered&#39;)</span>
    <span class="n">PI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">R21</span> <span class="o">=</span> <span class="n">PI</span> <span class="o">*</span> <span class="n">Wa</span>
    <span class="n">R22</span> <span class="o">=</span> <span class="n">PI</span> <span class="o">*</span> <span class="n">Wb</span>
    <span class="n">mshifts1</span> <span class="o">=</span> <span class="n">va</span>
    <span class="n">mshifts2</span> <span class="o">=</span> <span class="n">vb</span>
    <span class="n">pop1</span> <span class="o">=</span> <span class="n">pa</span>
    <span class="n">pop2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pop1</span>  <span class="c1"># i.e. pb</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="n">pop2</span> <span class="o">/</span> <span class="n">ka</span>
    <span class="n">deltanu</span> <span class="o">=</span> <span class="n">va</span> <span class="o">-</span> <span class="n">vb</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">tau</span> <span class="o">*</span> <span class="p">(</span><span class="n">R21</span> <span class="o">+</span> <span class="n">R22</span><span class="p">)</span>
    <span class="n">Rr2</span> <span class="o">=</span> <span class="n">PI</span> <span class="o">*</span> <span class="n">deltanu</span> <span class="o">*</span> <span class="n">tau</span> <span class="o">*</span> <span class="p">(</span><span class="n">R22</span> <span class="o">-</span> <span class="n">R21</span><span class="p">)</span>
    <span class="n">R3</span> <span class="o">=</span> <span class="n">PI</span> <span class="o">*</span> <span class="n">deltanu</span> <span class="o">*</span> <span class="p">(</span><span class="n">pop1</span> <span class="o">-</span> <span class="n">pop2</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">*</span> <span class="n">R21</span> <span class="o">*</span> <span class="n">R22</span>
    <span class="n">p3</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">*</span> <span class="n">PI</span> <span class="o">*</span> <span class="n">PI</span> <span class="o">*</span> <span class="n">deltanu</span> <span class="o">*</span> <span class="n">deltanu</span>
    <span class="n">PI2</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">PI</span> <span class="o">*</span> <span class="n">PI</span>
    <span class="n">pitau</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">PI</span>
    <span class="n">popratio1</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">p3</span> <span class="o">+</span> <span class="p">(</span><span class="n">pop1</span> <span class="o">*</span> <span class="n">R21</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">pop2</span> <span class="o">*</span> <span class="n">R22</span><span class="p">)</span>
    <span class="n">popratio2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">tau</span> <span class="o">*</span> <span class="p">((</span><span class="n">pop2</span> <span class="o">*</span> <span class="n">R21</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">pop1</span> <span class="o">*</span> <span class="n">R22</span><span class="p">))</span>
    <span class="n">CentFreq</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">mshifts1</span> <span class="o">+</span> <span class="n">mshifts2</span><span class="p">)</span>
    <span class="n">Delfreq</span> <span class="o">=</span> <span class="n">CentFreq</span> <span class="o">-</span> <span class="n">v</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">PI2</span> <span class="o">*</span> <span class="n">Delfreq</span> <span class="o">*</span> <span class="n">Delfreq</span>
    <span class="n">P</span> <span class="o">=</span> <span class="o">-</span><span class="n">p2</span> <span class="o">+</span> <span class="n">popratio1</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">pitau</span> <span class="o">*</span> <span class="n">Delfreq</span> <span class="o">-</span> <span class="n">tau</span> <span class="o">*</span> <span class="n">R3</span>
    <span class="n">R</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">PI</span> <span class="o">*</span> <span class="n">Delfreq</span> <span class="o">*</span> <span class="n">r1</span> <span class="o">+</span> <span class="n">Rr2</span> <span class="o">+</span> <span class="n">R3</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">P</span> <span class="o">*</span> <span class="n">popratio2</span> <span class="o">+</span> <span class="n">Q</span> <span class="o">*</span> <span class="n">R</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">P</span> <span class="o">*</span> <span class="n">P</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">R</span> <span class="o">*</span> <span class="n">R</span><span class="p">))</span></div>


<div class="viewcode-block" id="TwoSinglets"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.TwoSinglets">[docs]</a><span class="k">class</span> <span class="nc">TwoSinglets</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attempt at using a class instead of separate functions to represent two</span>
<span class="sd">    uncoupled spin-1/2 nuclei undergoing exchange.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">pi_squared</span> <span class="o">=</span> <span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vb</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">wa</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">wb</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">percent_a</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the system with the required parameters:</span>
<span class="sd">        :param va: Frequency of nucleus a</span>
<span class="sd">        :param vb: Frequency of nucleus b (must be &lt; va)</span>
<span class="sd">        :param k: Rate of nuclear exchange</span>
<span class="sd">        :param wa: With at half height for va signal at the slow exchange limit</span>
<span class="sd">        :param wb: With at half height for vb signal at the slow exchange limit</span>
<span class="sd">        :param percent_a: Fractional population of state &#39;a&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Idea is to complete the frequency-independent calculations when the</span>
        <span class="c1">#  class is instantiated, and thus calculations may be faster.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_limit</span> <span class="o">=</span> <span class="n">vb</span> <span class="o">-</span> <span class="mi">50</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_limit</span> <span class="o">=</span> <span class="n">va</span> <span class="o">+</span> <span class="mi">50</span>

        <span class="n">T2a</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">wa</span><span class="p">)</span>
        <span class="n">T2b</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">wb</span><span class="p">)</span>
        <span class="n">pa</span> <span class="o">=</span> <span class="n">percent_a</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="n">pb</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">pb</span> <span class="o">/</span> <span class="n">k</span>
        <span class="n">dv</span> <span class="o">=</span> <span class="n">va</span> <span class="o">-</span> <span class="n">vb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Dv</span> <span class="o">=</span> <span class="p">(</span><span class="n">va</span> <span class="o">+</span> <span class="n">vb</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">T2a</span> <span class="o">*</span> <span class="n">T2b</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_squared</span> <span class="o">*</span> <span class="p">(</span><span class="n">dv</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> \
            <span class="o">+</span> <span class="p">(</span><span class="n">pa</span> <span class="o">/</span> <span class="n">T2a</span> <span class="o">+</span> <span class="n">pb</span> <span class="o">/</span> <span class="n">T2b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">*</span> <span class="p">((</span><span class="n">pb</span> <span class="o">/</span> <span class="n">T2a</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">pa</span> <span class="o">/</span> <span class="n">T2b</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">dv</span> <span class="o">*</span> <span class="p">(</span><span class="n">pa</span> <span class="o">-</span> <span class="n">pb</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">dv</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="n">T2b</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">T2a</span><span class="p">))</span> \
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">dv</span> <span class="o">*</span> <span class="p">(</span><span class="n">pa</span> <span class="o">-</span> <span class="n">pb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="n">T2a</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">T2b</span><span class="p">)))</span>

<div class="viewcode-block" id="TwoSinglets.intensity"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.TwoSinglets.intensity">[docs]</a>    <span class="k">def</span> <span class="nf">intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Yield a function for the lineshape for TwoSinglets</span>
<span class="sd">        :param v: frequency</span>
<span class="sd">        :return: a frequency-dependent function that returns the intensity of</span>
<span class="sd">        the spectrum at frequency v</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: add to docstring</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span>
        <span class="n">Dv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dv</span>
        <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span>
        <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span>
        <span class="n">Dv</span> <span class="o">-=</span> <span class="n">v</span>
        <span class="n">P</span> <span class="o">-=</span> <span class="n">tau</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_squared</span> <span class="o">*</span> <span class="p">(</span><span class="n">Dv</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">+=</span> <span class="n">tau</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Dv</span>
        <span class="n">R</span> <span class="o">+=</span> <span class="n">Dv</span> <span class="o">*</span> <span class="n">r</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">P</span> <span class="o">*</span> <span class="n">p</span> <span class="o">+</span> <span class="n">Q</span> <span class="o">*</span> <span class="n">R</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">P</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">R</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TwoSinglets.spectrum"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.TwoSinglets.spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate a DNMR spectrum, using the parameters TwoSinglets was</span>
<span class="sd">        instantiated with.</span>
<span class="sd">        :return: a tuple of numpy arrays (x = numpy linspace representing</span>
<span class="sd">        frequencies, y = numpy array of intensities along those frequencies)pwd</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_limit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_limit</span><span class="p">,</span> <span class="mi">800</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span></div></div>


<div class="viewcode-block" id="dnmr_AB"><a class="viewcode-back" href="../../nmrtools.html#nmrtools.nmrmath.dnmr_AB">[docs]</a><span class="k">def</span> <span class="nf">dnmr_AB</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">W</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A translation of the equation from Weil&#39;s JCE paper (NOTE: Reich pointed</span>
<span class="sd">    out that it has a sign typo!).</span>
<span class="sd">    p. 14, for the uncoupled 2-site exchange simulation.</span>
<span class="sd">    v: frequency whose amplitude is to be calculated</span>
<span class="sd">    va, vb: frequencies of a and b nuclei (slow exchange limit, no coupling;</span>
<span class="sd">    va &gt; vb)</span>
<span class="sd">    ka: rate constant for state A--&gt; state B</span>
<span class="sd">    pa: fraction of population in state Adv: frequency difference (va - vb)</span>
<span class="sd">    between a and b singlets (slow exchange)</span>
<span class="sd">    T2a, T2b: T2 (transverse relaxation time) for each nuclei</span>
<span class="sd">    returns: amplitude at frequency v</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">vo</span> <span class="o">=</span> <span class="p">(</span><span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">k</span>
    <span class="n">tau2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="n">W</span><span class="p">)</span>
    <span class="n">a1_plus</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">vo</span> <span class="o">-</span> <span class="n">v</span> <span class="o">+</span> <span class="n">J</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">a1_minus</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">vo</span> <span class="o">-</span> <span class="n">v</span> <span class="o">-</span> <span class="n">J</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="o">-</span> <span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">tau2</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">a3</span> <span class="o">=</span> <span class="o">-</span> <span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">v1</span> <span class="o">-</span> <span class="n">v2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">a4</span> <span class="o">=</span> <span class="o">-</span> <span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">J</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">tau</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">a_plus</span> <span class="o">=</span> <span class="n">a1_plus</span> <span class="o">+</span> <span class="n">a2</span> <span class="o">+</span> <span class="n">a3</span> <span class="o">+</span> <span class="n">a4</span>
    <span class="n">a_minus</span> <span class="o">=</span> <span class="n">a1_minus</span> <span class="o">+</span> <span class="n">a2</span> <span class="o">+</span> <span class="n">a3</span> <span class="o">+</span> <span class="n">a4</span>

    <span class="n">b_plus</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">vo</span> <span class="o">-</span> <span class="n">v</span> <span class="o">+</span> <span class="n">J</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
        <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">tau2</span><span class="p">))</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">J</span> <span class="o">/</span> <span class="n">tau</span>
    <span class="n">b_minus</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">vo</span> <span class="o">-</span> <span class="n">v</span> <span class="o">-</span> <span class="n">J</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
        <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">tau2</span><span class="p">))</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">J</span> <span class="o">/</span> <span class="n">tau</span>

    <span class="n">r_plus</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">vo</span> <span class="o">-</span> <span class="n">v</span> <span class="o">+</span> <span class="n">J</span><span class="p">)</span>
    <span class="n">r_minus</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">vo</span> <span class="o">-</span> <span class="n">v</span> <span class="o">-</span> <span class="n">J</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">tau2</span><span class="p">)</span>

    <span class="n">n1</span> <span class="o">=</span> <span class="n">r_plus</span> <span class="o">*</span> <span class="n">b_plus</span> <span class="o">-</span> <span class="n">s</span> <span class="o">*</span> <span class="n">a_plus</span>
    <span class="n">d1</span> <span class="o">=</span> <span class="n">a_plus</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">b_plus</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">r_minus</span> <span class="o">*</span> <span class="n">b_minus</span> <span class="o">-</span> <span class="n">s</span> <span class="o">*</span> <span class="n">a_minus</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="n">a_minus</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">b_minus</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="n">I</span> <span class="o">=</span> <span class="p">(</span><span class="n">n1</span> <span class="o">/</span> <span class="n">d1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">n2</span> <span class="o">/</span> <span class="n">d2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">I</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Geoffrey M. Sametz.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>